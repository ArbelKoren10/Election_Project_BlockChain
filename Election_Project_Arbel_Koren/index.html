<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>×‘×—×™×¨×•×ª 2026 - ×¤×¨×•×™×§×˜ ×’××¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.8.2/web3.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; }
        .container { background: white; max-width: 800px; margin: 0 auto; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; color: #34495e; }
        
        /* ×¢×™×¦×•×‘ ×›×¤×ª×•×¨×™× ×•×ª×™×‘×•×ª */
        button { background-color: #3498db; color: white; border: none; padding: 10px 20px; font-size: 16px; border-radius: 8px; cursor: pointer; margin: 5px; transition: 0.3s; }
        button:hover { background-color: #2980b9; transform: translateY(-2px); }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 60%; margin: 5px 0; font-size: 16px; }
        
        /* ×¢×™×¦×•×‘ ×¨×©×™××ª ×”××•×¢××“×™× */
        .box { background: #ecf0f1; padding: 15px; margin: 10px 0; border-radius: 8px; }
        .candidate-item { display: flex; justify-content: space-between; align-items: center; text-align: right; }
        
        #status { font-weight: bold; margin-top: 20px; color: #e74c3c; min-height: 20px; }
        .data-display { font-size: 18px; color: #27ae60; font-weight: bold; margin: 10px 0; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ—³ï¸ ××¢×¨×›×ª ×‘×—×™×¨×•×ª ××‘×•×–×¨×ª 2026</h1>
        
        <div class="box">
            <div>×›×ª×•×‘×ª ××¨× ×§: <span id="userAddress">×œ× ××—×•×‘×¨</span></div>
            <div>×™×ª×¨×ª ××˜×‘×¢×•×ª (BAL): <span id="balanceDisplay" class="data-display">0</span></div>
        </div>

        <div id="adminSection">
            <h2>ğŸ‘® ××–×•×¨ × ×™×”×•×œ</h2>
            <input type="text" id="candName" placeholder="×©× ×”××•×¢××“ (×œ××©×œ: ×“× ×™)">
            <input type="text" id="candOpinions" placeholder="×“×¢×•×ª (×œ××©×œ: 1,9,5)">
            <br>
            <button onclick="addCandidate()">â• ×”×•×¡×£ ××•×¢××“</button>
            <hr>
            <input type="number" id="duration" placeholder="×“×§×•×ª ×œ×‘×—×™×¨×•×ª" value="10" style="width: 100px;">
            <button onclick="startElection()" style="background-color: #e67e22;">ğŸš€ ×”×ª×—×œ ×‘×—×™×¨×•×ª</button>
        </div>

        <div id="voteSection">
            <h2>ğŸ‘‡ ××–×•×¨ ×”×¦×‘×¢×”</h2>
            <div id="candidatesList" class="box">
                <em>×˜×•×¢×Ÿ ××•×¢××“×™×...</em>
            </div>

            <h3>ğŸ¤– ×”×‘×•×˜ ×”×—×›×</h3>
            <p>×”×›× ×¡ ××ª ×”×¢×“×¤×•×ª×™×š (1-10) ×•×”××¢×¨×›×ª ×ª×‘×—×¨ ×‘×©×‘×™×œ×š ××ª ×”××•×¢××“ ×”××ª××™×:</p>
            <input type="text" id="myOpinions" placeholder="×”×¢×“×¤×•×ª ×©×œ×™ (×œ××©×œ: 10,2,8)">
            <br>
            <button onclick="voteSmart()" style="background-color: #9b59b6;">âœ¨ ×”×¦×‘×¢×” ×—×›××”</button>
        </div>

        <p id="status"></p>
    </div>

    <script>
        let account;
        let web3;
        let electionContract;
        let tokenContract;

        // --- 1. ××–×•×¨ ×”×”×’×“×¨×•×ª (×× ×¢×©×™×ª DEPLOY ××—×“×© - ×¢×“×›×Ÿ ×›××Ÿ!) ---
        
        // ×”×“×‘×§ ×›××Ÿ ××ª ×›×ª×•×‘×ª ×”×‘×—×™×¨×•×ª ×”×—×“×©×”
        const ELECTION_ADDRESS = "0xB1d42cbC5033d14847535d82c475ea0D1BcCce7E";

        // ×”×“×‘×§ ×›××Ÿ ××ª ×›×ª×•×‘×ª ×”××˜×‘×¢ ×”×—×“×©×”
        const TOKEN_ADDRESS = "0x154bbb1dA34a55AF27f1f40a55489340ef21Ce97";

        // ×”-ABI (×œ× ×¦×¨×™×š ×œ×©× ×•×ª)
        const ELECTION_ABI = [
    {
        "inputs": [
            {
                "internalType": "string",
                "name": "_name",
                "type": "string"
            },
            {
                "internalType": "uint256[3]",
                "name": "_opinions",
                "type": "uint256[3]"
            }
        ],
        "name": "addCandidate",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "bytes32",
                "name": "_root",
                "type": "bytes32"
            }
        ],
        "name": "setMerkleRoot",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "_durationInMinutes",
                "type": "uint256"
            }
        ],
        "name": "startElection",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "_tokenAddress",
                "type": "address"
            }
        ],
        "stateMutability": "nonpayable",
        "type": "constructor"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "_candidateId",
                "type": "uint256"
            },
            {
                "internalType": "bytes32[]",
                "name": "_proof",
                "type": "bytes32[]"
            }
        ],
        "name": "vote",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "admin",
        "outputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "name": "candidates",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "id",
                "type": "uint256"
            },
            {
                "internalType": "string",
                "name": "name",
                "type": "string"
            },
            {
                "internalType": "uint256",
                "name": "voteCount",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "electionEndTime",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "electionStarted",
        "outputs": [
            {
                "internalType": "bool",
                "name": "",
                "type": "bool"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "uint256",
                "name": "_index",
                "type": "uint256"
            }
        ],
        "name": "getCandidate",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            },
            {
                "internalType": "string",
                "name": "",
                "type": "string"
            },
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            },
            {
                "internalType": "uint256[3]",
                "name": "",
                "type": "uint256[3]"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "getCandidatesCount",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "getTestRootAndProof",
        "outputs": [
            {
                "internalType": "bytes32",
                "name": "root",
                "type": "bytes32"
            },
            {
                "internalType": "bytes32[]",
                "name": "proof",
                "type": "bytes32[]"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {
                "internalType": "address",
                "name": "",
                "type": "address"
            }
        ],
        "name": "hasVoted",
        "outputs": [
            {
                "internalType": "bool",
                "name": "",
                "type": "bool"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "merkleRoot",
        "outputs": [
            {
                "internalType": "bytes32",
                "name": "",
                "type": "bytes32"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "rewardAmount",
        "outputs": [
            {
                "internalType": "uint256",
                "name": "",
                "type": "uint256"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "token",
        "outputs": [
            {
                "internalType": "contract IBalToken",
                "name": "",
                "type": "address"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    }
]; 
        
        const TOKEN_ABI = [
            { "constant": true, "inputs": [{"name": "_owner", "type": "address"}], "name": "balanceOf", "outputs": [{"name": "balance", "type": "uint256"}], "type": "function" }
        ];

        // --- 2. ×”×ª×—×‘×¨×•×ª ×œ-MetaMask ---
        window.onload = async function() {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    account = accounts[0];
                    document.getElementById("userAddress").innerText = account;
                    
                    electionContract = new web3.eth.Contract(ELECTION_ABI, ELECTION_ADDRESS);
                    tokenContract = new web3.eth.Contract(TOKEN_ABI, TOKEN_ADDRESS);

                    console.log("××—×•×‘×¨ ×‘×”×¦×œ×—×”!");
                    updateData();

                } catch (error) {
                    console.error("User denied account access");
                }
            } else {
                alert("×× × ×”×ª×§×Ÿ MetaMask!");
            }
        };

        // --- 3. ×¢×“×›×•×Ÿ × ×ª×•× ×™× (×›×•×œ×œ ×”×¦×’×” ×©×œ ×›×¤×ª×•×¨ ×”×¦×‘×¢×” ×™×©×™×¨×”) ---
        async function updateData() {
            // ×™×ª×¨×”
            const balance = await tokenContract.methods.balanceOf(account).call();
            const formatBalance = web3.utils.fromWei(balance, 'ether'); 
            document.getElementById("balanceDisplay").innerText = formatBalance;

            // ×¨×©×™××ª ××•×¢××“×™×
            const count = await electionContract.methods.getCandidatesCount().call();
            let html = "";
            for (let i = 0; i < count; i++) {
                const c = await electionContract.methods.getCandidate(i).call();
                // ×”×ª×™×§×•×Ÿ ×›××Ÿ: ×”×•×¡×¤× ×• ×›×¤×ª×•×¨ ×™×¨×•×§ ×œ×”×¦×‘×¢×” ×™×©×™×¨×”
                html += `<div class='box candidate-item'>
                            <div>
                                <strong>${c[1]}</strong> (×§×•×œ×•×ª: ${c[2]})<br>
                                <small>×“×¢×•×ª: ${c[3]}</small>
                            </div>
                            <button onclick="voteDirect(${i})" style="background-color: #27ae60;">âœ‹ ×”×¦×‘×¢ ×œ${c[1]}</button>
                         </div>`;
            }
            document.getElementById("candidatesList").innerHTML = html;
        }

        // --- 4. ×¤×•× ×§×¦×™×•×ª ×œ××“××™×Ÿ ---
        async function addCandidate() {
            const name = document.getElementById("candName").value;
            const opinionsStr = document.getElementById("candOpinions").value;
            const opinions = opinionsStr.split(",").map(Number);

            document.getElementById("status").innerText = "×©×•×œ×— ×‘×§×©×” ×œ×”×•×¡×¤×ª ××•×¢××“...";
            try {
                await electionContract.methods.addCandidate(name, opinions).send({ from: account });
                document.getElementById("status").innerText = "âœ… ××•×¢××“ × ×•×¡×£ ×‘×”×¦×œ×—×”!";
                updateData();
            } catch (err) {
                document.getElementById("status").innerText = "âŒ ×©×’×™××”: " + err.message;
            }
        }

        async function startElection() {
            const minutes = document.getElementById("duration").value;
            document.getElementById("status").innerText = "××ª×—×™×œ ×‘×—×™×¨×•×ª...";
            try {
                const data = await electionContract.methods.getTestRootAndProof().call({from: account});
                const root = data[0];
                
                await electionContract.methods.setMerkleRoot(root).send({ from: account });
                await electionContract.methods.startElection(minutes).send({ from: account });
                
                document.getElementById("status").innerText = "âœ… ×”×‘×—×™×¨×•×ª ×”×ª×—×™×œ×•!";
            } catch (err) {
                document.getElementById("status").innerText = "âŒ ×©×’×™××”: " + err.message;
            }
        }

        // --- 5. ×”×¦×‘×¢×” ×™×©×™×¨×” (×—×“×©!) ---
        async function voteDirect(candidateId) {
            document.getElementById("status").innerText = "××‘×¦×¢ ×”×¦×‘×¢×” ×™×©×™×¨×”...";
            try {
                // ××©×™×’ ××ª ×”×”×•×›×—×”
                const data = await electionContract.methods.getTestRootAndProof().call({from: account});
                const proof = data[1];

                // ×©×•×œ×— ×”×¦×‘×¢×”
                await electionContract.methods.vote(candidateId, proof).send({ from: account });
                document.getElementById("status").innerText = "ğŸ‰ ×”×¦×‘×¢×” ×™×©×™×¨×” × ×§×œ×˜×”!";
                updateData();
            } catch (err) {
                document.getElementById("status").innerText = "âŒ ×©×’×™××”: " + err.message;
            }
        }

        // --- 6. ×”×¦×‘×¢×” ×—×›××” (×”×‘×•× ×•×¡) ---
        async function voteSmart() {
            const myOpsStr = document.getElementById("myOpinions").value;
            const myOps = myOpsStr.split(",").map(Number);

            document.getElementById("status").innerText = "××—×©×‘ ×”×ª×××”...";
            
            const count = await electionContract.methods.getCandidatesCount().call();
            let bestCandidateId = -1;
            let bestScore = 1000;

            for (let i = 0; i < count; i++) {
                const c = await electionContract.methods.getCandidate(i).call();
                const candOps = c[3];
                let currentScore = 0;
                for(let j=0; j<3; j++) {
                    currentScore += Math.abs(myOps[j] - Number(candOps[j]));
                }
                if (currentScore < bestScore) {
                    bestScore = currentScore;
                    bestCandidateId = i;
                }
            }

            if (bestCandidateId !== -1) {
                document.getElementById("status").innerText = `× ××¦××” ×”×ª×××”! ××¦×‘×™×¢ ×œ××•×¢××“ ××¡' ${bestCandidateId}...`;
                const data = await electionContract.methods.getTestRootAndProof().call({from: account});
                const proof = data[1];

                try {
                    await electionContract.methods.vote(bestCandidateId, proof).send({ from: account });
                    document.getElementById("status").innerText = "ğŸ‰ ×”×¦×‘×¢×” ×—×›××” ×‘×•×¦×¢×”!";
                    updateData();
                } catch (err) {
                    document.getElementById("status").innerText = "âŒ ×©×’×™××” ×‘×”×¦×‘×¢×”: " + err.message;
                }
            }
        }
    </script>

</body>
</html>